{"version":3,"file":"index.js","mappings":"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","sources":["webpack://tavern_helper_template/src/无双志/extension.js?6540","src://tavern_helper_template/webpack/bootstrap","src://tavern_helper_template/webpack/runtime/compat get default export","src://tavern_helper_template/webpack/runtime/define property getters","src://tavern_helper_template/webpack/runtime/hasOwnProperty shorthand","webpack://tavern_helper_template/src/无双志/index.js?bb01"],"sourcesContent":["/**\n * SillyTavern 扩展：多角色聊天文本分割与头像渲染\n * 支持批量格式化场景剧本、群聊日志等为独立角色块展示，自动加头像、美化格式。\n * 作者: 481784983-lang\n * 安装：放入 SillyTavern extensions 目录，或从 Github 安装本脚本\n */\n\n// ------ 角色头像映射表 ------\nconst avatarMap = {\n  \"董妵\": \"https://i.postimg.cc/YC8GLSM9/1762118116092.png\",\n  \"貂蝉\": \"https://i.postimg.cc/YC8GLSM0/1762118371125.png\",\n  \"夏侯惇\": \"https://i.postimg.cc/3wRyXHx7/1762119173735.png\",\n  \"孙策\": \"https://i.postimg.cc/LsXqtM8J/1762119880166.png\",\n  \"周瑜\": \"https://i.postimg.cc/9fM4djQw/1762119922194.png\",\n  \"孙姈\": \"https://i.postimg.cc/1ztgGZ3D/1762120081011.png\",\n  \"陆焰\": \"https://i.postimg.cc/SKsX6pxr/1762120196379.png\",\n  \"袁绍\": \"https://i.postimg.cc/QMyFSnFk/1762120290777.png\",\n  \"曹婥\": \"https://i.postimg.cc/rwg0RpMq/IMG-20251103-051232.png\",\n  \"吕凤仙\": \"https://i.postimg.cc/FKBYGnYG/IMG-20251103-055725.png\",\n  \"张娇\": \"https://i.postimg.cc/FKBYGnYC/IMG-20251103-055745.png\",\n  \"刘蓓\": \"https://i.postimg.cc/yNbDnrDb/IMG-20251103-055801.png\",\n  \"关云\": \"https://i.postimg.cc/W4HdSfDV/IMG-20251103-055815.png\",\n  \"张绯\": \"https://i.postimg.cc/W4HdSfDj/IMG-20251103-055827.png\",\n  \"赵云\": \"https://i.postimg.cc/SsYJP793/IMG-20251103-055845.png\",\n  \"诸葛亮\": \"https://i.postimg.cc/RFJNYQfx/IMG-20251103-055911.png\",\n  \"许褚\": \"https://i.postimg.cc/FRk76gcN/IMG-20251103-055937.png\",\n  \"郭嘉\": \"https://i.postimg.cc/j5nL1QNs/IMG-20251103-055948.png\",\n  \"荀彧\": \"https://i.postimg.cc/d1ZLfmds/IMG-20251103-060004.png\",\n  \"于吉\": \"https://i.postimg.cc/x8rcVJyT/IMG-20251103-060043.png\",\n  \"南华\": \"https://i.postimg.cc/qqfzHhX7/IMG-20251103-060052.png\",\n  \"左慈\": \"https://i.postimg.cc/d3MLckm1/IMG-20251103-060103.png\",\n  \"默认\": \"https://i.postimg.cc/52BdWZVT/default.png\"\n};\n\n// ------ UI状态栏：初始骨架数据 ------\nconst initialStatusBarState = JSON.parse(String.raw`{\n  \"世界\" : {\n    \"时间\" : [\n      \"\",\n      \"当前的游戏内日期。随剧情推进更新，格式为：XXN年 (公元 YYYY年)。请AI根据剧情（如战斗、旅行）合理推进时间。\" \n    ],\n    \"地点\" : [\n      \"\",\n      \"主角<user>当前所在的具体地点。e.g., 洛阳->虎牢关\" \n    ]\n  },\n  \"主角\" : {\n    \"势力\" : [\n      \"群雄\" ,\n      \"【UI主题核心】主角<user>当前所属势力。UI将根据此值自动切换主题 ('群雄', '炎汉', '魏', '吴')。\"\n    ],\n    \"声望\" : [\n      \"无名之辈\" ,\n      \"主角<user>在天下的声望等级。随重大事件更新。e.g., 无名之辈 -> 崭露TP角 -> 威震一方 -> 天下闻名 -> 人道魁首\"\n    ],\n    \"命\" : [\n      1000,\n      \"【最大生命值】。AI应根据'武力'、'血脉'等进行设定。\" \n    ],\n    \"法\" : [\n      1000,\n      \"【最大法力值】。AI应根据'谋略'、'血脉'等进行设定。\" \n    ],\n    \"武力\" : [\n      0,\n      \"[1-100]，主角<user>的武力值。随锻炼、奇遇或血脉觉醒更新。\" \n    ],\n    \"谋略\" : [\n      0,\n      \"[1-100]，主角<user>的谋略值。随学习或经历更新。\" \n    ],\n    \"魅力\" : [\n      0,\n      \"[1-100]，主角<user>的魅力值。随事迹或血脉觉醒更新。\" \n    ],\n    \"官职\" : [\n      \"无\" ,\n      \"主角的官职，由汉室(曹婥)册封，影响声望和权限。\" \n    ],\n    \"血脉\" : [\n      \"凡人\" ,\n      \"主角觉醒的血脉。e.g., 凡人, 亚龙血脉, 魔裔。\"\n    ],\n    \"仙术\" : [\n      {\n        \"$meta\" : {\n          \"extensible\" : true ,\n          \"template\" : {\n            \"名称\" : [\"新仙术\" , \"【类型】\" ],\n            \"类型\" : [\"未知\" , \"e.g., 奇门, 符咒, 召唤\"],\n            \"消耗\" : [\"法力 0\" , \"发动消耗\" ],\n            \"描述\" : [\"暂无描述。\" , \"\"]\n          }\n        }\n      },\n      \"主角学会的仙术/奇门。\" \n    ]\n  },\n  \"行囊\" : {\n    \"装备\" : {\n      \"武器\" : [\"无\" , \"当前装备的武器。\" ],\n      \"防具\" : [\"无\" , \"当前装备的防具。\" ],\n      \"饰品\" : [\"无\" , \"当前装备的饰品。\" ]\n    },\n    \"背包\" : [\n      {\n        \"$meta\" : {\n          \"extensible\" : true ,\n          \"template\" : {\n            \"名称\" : [\"新物品\" , \"【消耗品】\" ],\n            \"数量\" : [1, \"描述：...\" ],\n            \"描述\" : [\"暂无描述。\" , \"\"]\n          }\n        }\n      },\n      \"存放消耗品、材料、任务道具。\" \n    ]\n  },\n  \"关系表\" : [\n    { \"$meta\" : { \"extensible\" : true  } },\n    \"一个对象，用于【快速查阅】<user>已建立的【特殊羁绊】。键是人名(snake_case)，值是关系。AI应在'结缘录.xxx.当前关系'更新为'至交'、'妻子'、'宿敌'等特殊关系时，【同步】更新此表。\" \n  ],\n  \"结缘录\" : [\n    {\n      \"$meta\" : {\n        \"extensible\" : true ,\n        \"required\" : [\n          \"姓名\" ,\n          \"年龄\" ,\n          \"命\" ,\n          \"法\" ,\n          \"好感度\" ,\n          \"仙术\" ,\n          \"背包\" \n        ],\n        \"template\" : {\n          \"姓名\" : [\"？？？\", \"字？？？\" ],\n          \"年龄\" : [0, \"？？？\"],\n          \"官职\" : [\"无\" , \"？？？\"],\n          \"武力\" : [0, \"[1-100+]\"],\n          \"谋略\" : [0, \"[1-100+]\"],\n          \"魅力\" : [0, \"[1-100+]\"],\n          \"命\" : [100, \"【最大生命值】\" ],\n          \"法\" : [100, \"【最大法力值】\" ],\n          \"坐骑\" : [\"无\" , \"？？？\"],\n          \"衣着\" : [\"暂无描述。\" , \"当前装束\" ],\n          \"外貌\" : [\"暂无描述。\" , \"外貌特征\" ],\n          \"武器\" : [\"【凡品】无\" , \"？？？\"],\n          \"好感度\" : [0, \"[-1000 - +1000] (陌生)\"],\n          \"当前关系\" : [\"陌生\" , \"？？？\"],\n          \"仙术\" : [\n            {\n              \"$meta\" : {\n                \"extensible\" : true ,\n                \"template\" : {\n                  \"名称\" : [\"新仙术\" , \"【血脉】\" ],\n                  \"消耗\" : [\"法力 0\" , \"\"],\n                  \"描述\" : [\"暂无描述。\" , \"\"]\n                }\n              }\n            },\n            \"‘将姫’的血脉能力与武技。\" \n          ],\n          \"背包\" : [\n            {\n              \"$meta\" : {\n                \"extensible\" : true ,\n                \"template\" : {\n                  \"名称\" : [\"新物品\" , \"【消耗品】\" ],\n                  \"数量\" : [1, \"描述：...\" ],\n                  \"描述\" : [\"暂无描述。\" , \"\"]\n                }\n              }\n            },\n            \"‘将姫’的随身行囊。\" \n          ]\n        }\n      }\n    },\n    \"此表记录所有重要NPC的【详细数据】。当<user>遇到新'将姫'时，AI应按此格式添加新条目。\" \n  ],\n  \"天下闻\" : {\n    \"奇闻\" : [\n      \"（暂无奇闻）\" ,\n      \"【V4.0规则】战略总览 (已确认的情报)。用 \\\\n 换行，记录【将姫】的军队动向和【神魔】的踪迹。e.g., \\\\n【将姫】曹婥(女)已于陈留起兵。\\\\n【神魔】'魔王'董妵(女)已抵达洛阳。\"\n    ],\n    \"当前剧情\" : [\n      \"（等待开局...）\" ,\n      \"【V4.0规则】<user>的实时冒险日志。总结<user>刚做了什么，和下一步的目标。\"\n    ]\n  },\n  \"宿命诗\" : [\n    \"（暂无诗篇）\" ,\n    \"AI在剧情关键节点创作的七言律诗，总结宿命与史诗。\"\n  ]\n}`);\n\nconst COLLAPSIBLE_SECTIONS = new Set(['主角', '行囊', '结缘录', '天下闻']);\nconst COLLAPSE_ANIMATION_MS = 260;\n\nconst SECTION_EPITHETS = {\n  世界: '乾坤之象，风云与共',\n  主角: '天命所钟，英姿无双',\n  行囊: '囊萃百宝，随征万里',\n  关系表: '金兰谱牒，肝胆相照',\n  结缘录: '红尘邂逅，丹青留痕',\n  天下闻: '四海风声，鼓角惊雷',\n  宿命诗: '金石同韵，悲欢共吟'\n};\n\nconst SECTION_ICON_MAP = {\n  世界: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"12\" cy=\"12\" r=\"9\"/><path d=\"M3 12h18M12 3a15 15 0 0 1 0 18m0-18a15 15 0 0 0 0 18\"/></svg>`,\n  主角: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"12\" cy=\"9\" r=\"3.5\"/><path d=\"M5.5 20a6.5 6.5 0 0 1 13 0\"/></svg>`,\n  行囊: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M5 9h14l-.7 9.4a2 2 0 0 1-2 1.6H7.7a2 2 0 0 1-2-1.6L5 9Z\"/><path d=\"M9 9V6.5A2.5 2.5 0 0 1 11.5 4h1a2.5 2.5 0 0 1 2.5 2.5V9\"/></svg>`,\n  关系表: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"5\" cy=\"12\" r=\"2.5\"/><circle cx=\"19\" cy=\"7\" r=\"2.5\"/><circle cx=\"19\" cy=\"17\" r=\"2.5\"/><path d=\"M7.3 11.3 16.6 7.9M7.3 12.7l9.3 3.4\"/></svg>`,\n  结缘录: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M6 4h9a3 3 0 0 1 3 3v13l-4.5-2L9 20l-.2-.1A3 3 0 0 1 6 17V4Z\"/><path d=\"M9 8h6\"/></svg>`,\n  天下闻: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M4 10v4a2 2 0 0 0 2 2h2l4 4V4l-4 4H6a2 2 0 0 0-2 2Z\"/><path d=\"M19 8v8\"/></svg>`,\n  default: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"12\" cy=\"12\" r=\"8\"/></svg>`\n};\n\nconst SUBGROUP_ICON_MAP = {\n  装备: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M12 3v18M6 7l6-4 6 4M6 17l6 4 6-4\"/></svg>`,\n  背包: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M6.5 8h11l1 11a2 2 0 0 1-2 2H7.5a2 2 0 0 1-2-2l1-11Z\"/><path d=\"M9 8V6a3 3 0 0 1 3-3 3 3 0 0 1 3 3v2\"/></svg>`,\n  default: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><rect x=\"5\" y=\"6\" width=\"14\" height=\"12\" rx=\"2\"/></svg>`\n};\n\nconst ITEM_ICON_MAP = {\n  时间: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"12\" cy=\"12\" r=\"8\"/><path d=\"M12 8v4l2.5 2\"/></svg>`,\n  地点: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M12 21s6-5.2 6-11a6 6 0 0 0-12 0c0 5.8 6 11 6 11Z\"/><circle cx=\"12\" cy=\"10\" r=\"2.5\"/></svg>`,\n  势力: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M4 12h16M4 8h16M4 16h10\"/></svg>`,\n  声望: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"m5 12 7-7 7 7\"/><path d=\"M5 12h14v7H5z\"/></svg>`,\n  命: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M12 21C12 21 5 15 5 9a7 7 0 0 1 14 0c0 6-7 12-7 12Z\"/></svg>`,\n  法: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M12 3v18\"/><path d=\"M7 7h10\"/><path d=\"M7 12h10\"/><path d=\"M7 17h10\"/></svg>`,\n  武力: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M8 12h8\"/><path d=\"m6 7 6-4 6 4\"/><path d=\"m6 17 6 4 6-4\"/></svg>`,\n  谋略: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M12 21a9 9 0 1 1 8.95-10.2\"/><path d=\"M12 7v5l3 3\"/></svg>`,\n  魅力: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M12 21c-4-3-7-6.5-7-10A7 7 0 0 1 12 4a7 7 0 0 1 7 7c0 3.5-3 7-7 10Z\"/></svg>`,\n  官职: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><rect x=\"6\" y=\"7\" width=\"12\" height=\"10\" rx=\"2\"/><path d=\"M9 7V5h6v2\"/></svg>`,\n  血脉: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M12 4v16\"/><path d=\"M7 8c1.5 1.5 3 2 5 2s3.5-.5 5-2\"/><path d=\"M7 16c1.5-1.5 3-2 5-2s3.5.5 5 2\"/></svg>`,\n  仙术: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"m12 3 2.4 4.9L20 9l-4 3.9.9 5.6L12 16l-4.9 2.5.9-5.6L4 9l5.6-.1Z\"/></svg>`,\n  装备: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M5 7h14v10H5z\"/><path d=\"M9 7V5h6v2\"/></svg>`,\n  背包: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M7 7h10l1 11a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2l1-11Z\"/></svg>`,\n  奇闻: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"m5 8 7-5 7 5v8l-7 5-7-5V8Z\"/><path d=\"M9 10h6\"/></svg>`,\n  当前剧情: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M4 5h16v14H4z\"/><path d=\"M8 5v14\"/><path d=\"m12 14 2.5 2 3.5-4\"/></svg>`,\n  关系表: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"12\" cy=\"7\" r=\"3\"/><path d=\"M5.5 21a6.5 6.5 0 0 1 13 0\"/></svg>`,\n  default: `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.6\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"12\" cy=\"12\" r=\"4\"/></svg>`\n};\n\nconst COLLAPSE_INDICATOR_SVG = `<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"1.8\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"m7 10 5 5 5-5\"/></svg>`;\n\nfunction createIconSpan(type, key) {\n  const map = type === 'section' ? SECTION_ICON_MAP : type === 'subgroup' ? SUBGROUP_ICON_MAP : ITEM_ICON_MAP;\n  const svg = map[key] || map.default;\n  if (!svg) {\n    return null;\n  }\n  const span = document.createElement('span');\n  span.className = `st-ext-icon st-ext-icon-${type}`;\n  span.setAttribute('aria-hidden', 'true');\n  span.setAttribute('role', 'presentation');\n  span.innerHTML = svg;\n  return span;\n}\n\nfunction createSectionShell(title, options = {}) {\n  const section = document.createElement('section');\n  section.className = 'st-ext-status-section';\n\n  const header = document.createElement('h3');\n  header.className = 'st-ext-status-heading';\n\n  const headerIcon = createIconSpan('section', title);\n  if (headerIcon) {\n    header.appendChild(headerIcon);\n  }\n\n  const headerText = document.createElement('span');\n  headerText.className = 'st-ext-heading-text';\n  headerText.textContent = title;\n  header.appendChild(headerText);\n\n  const headerEpithet = createSectionEpithet(title);\n  if (headerEpithet) {\n    header.appendChild(headerEpithet);\n  }\n\n  const content = document.createElement('div');\n  content.className = 'st-ext-section-content';\n\n  section.append(header, content);\n\n  let collapseControls = null;\n  if (options.collapsible) {\n    section.classList.add('st-ext-collapsible');\n    collapseControls = setupCollapsible(section, header, content, options);\n  }\n\n  return { section, header, content, collapseControls };\n}\n\nfunction setupCollapsible(section, header, content, options = {}) {\n  const { collapsed = false, duration = COLLAPSE_ANIMATION_MS } = options;\n\n  header.classList.add('st-ext-collapsible-trigger');\n  header.setAttribute('role', 'button');\n  header.setAttribute('aria-expanded', collapsed ? 'false' : 'true');\n  header.tabIndex = 0;\n\n  content.style.transition = `max-height ${duration}ms ease, opacity ${duration}ms ease`;\n\n  const indicator = document.createElement('span');\n  indicator.className = 'st-ext-collapse-indicator';\n  indicator.innerHTML = COLLAPSE_INDICATOR_SVG;\n  header.appendChild(indicator);\n\n  const setCollapsed = (state) => {\n    if (state) {\n      section.classList.add('is-collapsed');\n      header.setAttribute('aria-expanded', 'false');\n      requestAnimationFrame(() => {\n        content.style.maxHeight = '0px';\n        content.style.opacity = '0';\n      });\n    } else {\n      section.classList.remove('is-collapsed');\n      header.setAttribute('aria-expanded', 'true');\n      requestAnimationFrame(() => {\n        content.style.maxHeight = `${content.scrollHeight}px`;\n        content.style.opacity = '1';\n      });\n    }\n  };\n\n  const toggle = () => {\n    const isCollapsed = section.classList.contains('is-collapsed');\n    setCollapsed(!isCollapsed);\n  };\n\n  header.addEventListener('click', toggle);\n  header.addEventListener('keydown', (event) => {\n    if (event.key === 'Enter' || event.key === ' ') {\n      event.preventDefault();\n      toggle();\n    }\n  });\n\n  const refresh = () => {\n    if (!section.classList.contains('is-collapsed')) {\n      content.style.maxHeight = `${content.scrollHeight}px`;\n    }\n  };\n\n  if (typeof ResizeObserver !== 'undefined') {\n    const observer = new ResizeObserver(() => {\n      refresh();\n    });\n    observer.observe(content);\n  }\n\n  requestAnimationFrame(() => {\n    setCollapsed(collapsed);\n  });\n\n  return { setCollapsed, refresh };\n}\n\nfunction appendIconAndText(target, icon, text) {\n  if (icon) {\n    target.appendChild(icon);\n  }\n  const span = document.createElement('span');\n  span.textContent = text;\n  target.appendChild(span);\n}\n\nfunction createSectionEpithet(title, options = {}) {\n  const text = SECTION_EPITHETS[title];\n  if (!text) {\n    return null;\n  }\n\n  const { tagName = 'span', className = 'st-ext-heading-epithet' } = options;\n  const element = document.createElement(tagName);\n  element.className = className;\n  element.textContent = text;\n  return element;\n}\n\nfunction createStatusBarContainer() {\n  const container = document.createElement('div');\n  container.id = 'st-ext-status-bar';\n  container.className = 'st-ext-status-bar';\n  container.innerHTML = `\n    <header class=\"st-ext-status-header\">\n      <span class=\"st-ext-status-title st-ext-display-title\">无双志</span>\n      <span class=\"st-ext-status-sub\">群英谱牒·风云长歌</span>\n    </header>\n    <div class=\"st-ext-status-body\"></div>\n  `;\n  return container;\n}\n\nfunction extractEntryValue(entry) {\n  if (Array.isArray(entry)) {\n    const [value] = entry;\n    if (value && typeof value === 'object' && value.$meta) {\n      return '（待录入）';\n    }\n    return value ?? '';\n  }\n  if (entry && typeof entry === 'object' && entry.$meta) {\n    return '（待录入）';\n  }\n  return entry ?? '';\n}\n\nfunction renderPrimitiveSection(title, entries) {\n  const { section, content, collapseControls } = createSectionShell(title, {\n    collapsible: COLLAPSIBLE_SECTIONS.has(title)\n  });\n\n  let currentList = null;\n\n  const ensureList = () => {\n    if (!currentList) {\n      currentList = document.createElement('dl');\n      currentList.className = 'st-ext-status-list';\n    }\n  };\n\n  const flushList = () => {\n    if (currentList && currentList.children.length) {\n      content.appendChild(currentList);\n    }\n    currentList = null;\n  };\n\n  Object.entries(entries).forEach(([key, value]) => {\n    if (value && typeof value === 'object' && !Array.isArray(value) && !value.$meta) {\n      flushList();\n      const subDetails = document.createElement('div');\n      subDetails.className = 'st-ext-status-subgroup';\n      const subHeader = document.createElement('h4');\n      subHeader.className = 'st-ext-status-subheading';\n      const icon = createIconSpan('subgroup', key);\n      if (icon) {\n        subHeader.appendChild(icon);\n      }\n      const label = document.createElement('span');\n      label.className = 'st-ext-heading-text';\n      label.textContent = key;\n      subHeader.appendChild(label);\n      subDetails.appendChild(subHeader);\n\n      let subList = null;\n\n      Object.entries(value).forEach(([subKey, subValue]) => {\n        if (!subList) {\n          subList = document.createElement('dl');\n          subList.className = 'st-ext-status-list';\n        }\n        const dt = document.createElement('dt');\n        const dtIcon = createIconSpan('item', subKey);\n        if (dtIcon) {\n          dt.appendChild(dtIcon);\n        }\n        const dtLabel = document.createElement('span');\n        dtLabel.textContent = subKey;\n        dt.appendChild(dtLabel);\n        const dd = document.createElement('dd');\n        dd.textContent = extractEntryValue(subValue) || '—';\n        subList.append(dt, dd);\n      });\n\n      if (subList) {\n        subDetails.appendChild(subList);\n      }\n\n      content.appendChild(subDetails);\n      return;\n    }\n\n    ensureList();\n\n    if (Array.isArray(value) && value.length && typeof value[0] === 'object' && value[0].$meta) {\n      const dt = document.createElement('dt');\n      const dtIcon = createIconSpan('item', key);\n      if (dtIcon) {\n        dt.appendChild(dtIcon);\n      }\n      const dtLabel = document.createElement('span');\n      dtLabel.textContent = key;\n      dt.appendChild(dtLabel);\n      const dd = document.createElement('dd');\n      dd.textContent = '（待扩展条目）';\n      currentList.append(dt, dd);\n      return;\n    }\n\n    const dt = document.createElement('dt');\n    const dtIcon = createIconSpan('item', key);\n    if (dtIcon) {\n      dt.appendChild(dtIcon);\n    }\n    const dtLabel = document.createElement('span');\n    dtLabel.textContent = key;\n    dt.appendChild(dtLabel);\n    const dd = document.createElement('dd');\n    dd.textContent = extractEntryValue(value) || '—';\n    currentList.append(dt, dd);\n  });\n\n  flushList();\n\n  if (collapseControls) {\n    collapseControls.setCollapsed(false);\n    collapseControls.refresh();\n  }\n\n  return section;\n}\n\nfunction renderStatusBar(state) {\n  if (typeof window === 'undefined' || !window.document) {\n    return;\n  }\n\n  const root = document.querySelector('#st-ext-status-bar');\n  const container = root || createStatusBarContainer();\n  const body = container.querySelector('.st-ext-status-body');\n  body.innerHTML = '';\n\n  let odeValue = null;\n\n  Object.entries(state).forEach(([sectionTitle, sectionValue]) => {\n    if (sectionTitle === '宿命诗') {\n      odeValue = sectionValue;\n      return;\n    }\n\n    if (sectionTitle === '关系表') {\n      const { section, content, collapseControls } = createSectionShell(sectionTitle, {\n        collapsible: COLLAPSIBLE_SECTIONS.has(sectionTitle)\n      });\n      const info = document.createElement('p');\n      info.className = 'st-ext-status-placeholder';\n      appendIconAndText(info, createIconSpan('item', sectionTitle), '（暂无羁绊记录）');\n      content.appendChild(info);\n      if (collapseControls) {\n        collapseControls.setCollapsed(false);\n        collapseControls.refresh();\n      }\n      body.appendChild(section);\n      return;\n    }\n\n    if (Array.isArray(sectionValue)) {\n      const { section, content, collapseControls } = createSectionShell(sectionTitle, {\n        collapsible: COLLAPSIBLE_SECTIONS.has(sectionTitle)\n      });\n      const info = document.createElement('p');\n      info.className = 'st-ext-status-placeholder';\n      appendIconAndText(info, createIconSpan('item', sectionTitle), extractEntryValue(sectionValue) || '（待补充）');\n      content.appendChild(info);\n      if (collapseControls) {\n        collapseControls.setCollapsed(false);\n        collapseControls.refresh();\n      }\n      body.appendChild(section);\n      return;\n    }\n\n    if (sectionValue && typeof sectionValue === 'object') {\n      const section = renderPrimitiveSection(sectionTitle, sectionValue);\n      body.appendChild(section);\n      return;\n    }\n\n    const { section, content, collapseControls } = createSectionShell(sectionTitle, {\n      collapsible: COLLAPSIBLE_SECTIONS.has(sectionTitle)\n    });\n    const info = document.createElement('p');\n    info.className = 'st-ext-status-placeholder';\n    appendIconAndText(info, createIconSpan('item', sectionTitle), sectionValue || '—');\n    content.appendChild(info);\n    if (collapseControls) {\n      collapseControls.setCollapsed(false);\n      collapseControls.refresh();\n    }\n    body.appendChild(section);\n  });\n\n  if (odeValue !== null) {\n    const section = document.createElement('section');\n    section.className = 'st-ext-status-ode';\n\n    const title = document.createElement('div');\n    title.className = 'st-ext-display-title';\n    title.textContent = '宿命诗';\n    section.appendChild(title);\n\n    const odeEpithet = createSectionEpithet('宿命诗', {\n      tagName: 'div',\n      className: 'st-ext-ode-epithet'\n    });\n    if (odeEpithet) {\n      section.appendChild(odeEpithet);\n    }\n\n    const content = document.createElement('p');\n    content.className = 'st-ext-status-ode-content';\n    content.textContent = extractEntryValue(odeValue) || '（暂无诗篇）';\n    section.appendChild(content);\n\n    body.appendChild(section);\n  }\n\n  if (!root) {\n    document.body.appendChild(container);\n  }\n}\n\nfunction injectStatusBarStyles() {\n  if (typeof window === 'undefined' || !window.document) {\n    return;\n  }\n\n  if (document.getElementById('st-ext-status-bar-style')) {\n    return;\n  }\n\n  const style = document.createElement('style');\n  style.id = 'st-ext-status-bar-style';\n  style.textContent = `\n    #st-ext-status-bar {\n      position: fixed;\n      top: 16px;\n      right: 16px;\n      width: 340px;\n      max-height: 80vh;\n      overflow-y: auto;\n      padding: 22px 22px 26px;\n      background: linear-gradient(145deg, rgba(246, 235, 212, 0.94), rgba(230, 210, 174, 0.96));\n      color: #45321a;\n      border-radius: 20px;\n      border: 1px solid rgba(117, 94, 60, 0.35);\n      box-shadow: 0 20px 44px rgba(98, 72, 41, 0.32);\n      background-image:\n        radial-gradient(circle at 18% 12%, rgba(255, 255, 255, 0.42), transparent 60%),\n        radial-gradient(circle at 82% 88%, rgba(210, 181, 136, 0.38), transparent 68%);\n      font-family: \"ZCOOL XiaoWei\", \"Songti SC\", \"STSong\", \"Noto Serif SC\", serif;\n      z-index: 10000;\n      isolation: isolate;\n      scrollbar-width: thin;\n      scrollbar-color: rgba(152, 118, 72, 0.55) transparent;\n      backdrop-filter: blur(3px);\n    }\n\n    #st-ext-status-bar::before {\n      content: \"\";\n      position: absolute;\n      inset: 0;\n      border-radius: inherit;\n      background:\n        repeating-linear-gradient(140deg, rgba(124, 95, 58, 0.05) 0 16px, transparent 16px 32px),\n        repeating-linear-gradient(40deg, rgba(255, 255, 255, 0.08) 0 18px, transparent 18px 36px);\n      mix-blend-mode: multiply;\n      opacity: 0.55;\n      pointer-events: none;\n      z-index: -1;\n    }\n\n    #st-ext-status-bar::after {\n      content: \"\";\n      position: absolute;\n      inset: 4px;\n      border-radius: 16px;\n      border: 1px solid rgba(255, 255, 255, 0.32);\n      pointer-events: none;\n      z-index: -1;\n    }\n\n    #st-ext-status-bar::-webkit-scrollbar {\n      width: 6px;\n    }\n\n    #st-ext-status-bar::-webkit-scrollbar-thumb {\n      background: rgba(152, 118, 72, 0.55);\n      border-radius: 999px;\n    }\n\n    #st-ext-status-bar::-webkit-scrollbar-track {\n      background: transparent;\n    }\n\n    #st-ext-status-bar .st-ext-status-header {\n      display: flex;\n      flex-direction: column;\n      gap: 8px;\n      align-items: center;\n      padding-bottom: 14px;\n      margin-bottom: 18px;\n      border-bottom: 1px dashed rgba(117, 94, 60, 0.35);\n      position: relative;\n    }\n\n    #st-ext-status-bar .st-ext-status-header::after {\n      content: \"\";\n      position: absolute;\n      bottom: -1px;\n      width: 72%;\n      height: 2px;\n      background: linear-gradient(90deg, rgba(199, 155, 48, 0), rgba(199, 155, 48, 0.55), rgba(199, 155, 48, 0));\n      transform: translateY(50%);\n      pointer-events: none;\n    }\n\n    #st-ext-status-bar .st-ext-status-body {\n      display: flex;\n      flex-direction: column;\n      gap: 18px;\n    }\n\n    #st-ext-status-bar .st-ext-display-title {\n      font-size: 1.92rem;\n      letter-spacing: 0.18em;\n      font-weight: 700;\n      color: #cfa63a;\n      text-align: center;\n      width: 100%;\n      text-shadow: 0 2px 6px rgba(138, 94, 28, 0.35);\n    }\n\n    #st-ext-status-bar .st-ext-status-title {\n      display: block;\n      text-align: center;\n    }\n\n    #st-ext-status-bar .st-ext-status-sub {\n      font-size: 0.78rem;\n      color: rgba(101, 72, 36, 0.68);\n      letter-spacing: 0.18em;\n    }\n\n    #st-ext-status-bar .st-ext-status-section {\n      margin: 0;\n      padding: 14px 16px 16px;\n      background: rgba(255, 249, 236, 0.68);\n      border-radius: 14px;\n      border: 1px solid rgba(138, 105, 60, 0.25);\n      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.65);\n      position: relative;\n    }\n\n    #st-ext-status-bar .st-ext-status-section::before {\n      content: \"\";\n      position: absolute;\n      inset: 0;\n      border-radius: inherit;\n      border: 1px solid rgba(255, 255, 255, 0.3);\n      pointer-events: none;\n      opacity: 0.65;\n      z-index: 0;\n    }\n\n    #st-ext-status-bar .st-ext-status-section::after {\n      content: \"\";\n      position: absolute;\n      right: 18px;\n      top: 12px;\n      width: 42px;\n      height: 42px;\n      background: radial-gradient(circle at 0% 0%, rgba(199, 155, 48, 0.18), transparent 72%);\n      pointer-events: none;\n      z-index: 0;\n    }\n\n    #st-ext-status-bar .st-ext-status-section > * {\n      position: relative;\n      z-index: 1;\n    }\n\n    #st-ext-status-bar .st-ext-status-section:hover {\n      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.75), 0 4px 12px rgba(122, 92, 58, 0.16);\n    }\n\n    #st-ext-status-bar .st-ext-status-heading,\n    #st-ext-status-bar .st-ext-status-subheading {\n      display: flex;\n      align-items: center;\n      gap: 10px;\n      margin: 0;\n    }\n\n    #st-ext-status-bar .st-ext-status-heading {\n      font-size: 1.05rem;\n      color: #5d4426;\n      letter-spacing: 0.08em;\n      margin-bottom: 8px;\n      font-weight: 600;\n    }\n\n    #st-ext-status-bar .st-ext-status-heading::after {\n      content: \"\";\n      flex: 1;\n      height: 1px;\n      background: linear-gradient(90deg, rgba(101, 72, 36, 0.18), rgba(101, 72, 36, 0), rgba(101, 72, 36, 0));\n    }\n\n    #st-ext-status-bar .st-ext-status-subheading {\n      font-size: 0.9rem;\n      margin: 10px 0 6px;\n      color: #6b4d28;\n      letter-spacing: 0.05em;\n      position: relative;\n    }\n\n    #st-ext-status-bar .st-ext-status-subheading::after {\n      content: \"\";\n      position: absolute;\n      bottom: -4px;\n      left: 34px;\n      right: 0;\n      height: 1px;\n      background: linear-gradient(90deg, rgba(120, 83, 40, 0.25), rgba(120, 83, 40, 0));\n    }\n\n    #st-ext-status-bar .st-ext-heading-text {\n      flex: 0 0 auto;\n    }\n\n    #st-ext-status-bar .st-ext-heading-epithet {\n      margin-left: auto;\n      font-size: 0.76rem;\n      letter-spacing: 0.16em;\n      color: rgba(119, 88, 44, 0.85);\n      display: inline-flex;\n      align-items: center;\n      white-space: nowrap;\n      font-weight: 500;\n      text-shadow: 0 1px 0 rgba(255, 255, 255, 0.4);\n    }\n\n    #st-ext-status-bar .st-ext-heading-epithet::before,\n    #st-ext-status-bar .st-ext-heading-epithet::after {\n      color: rgba(199, 155, 72, 0.8);\n    }\n\n    #st-ext-status-bar .st-ext-heading-epithet::before {\n      content: '「';\n      margin-right: 3px;\n    }\n\n    #st-ext-status-bar .st-ext-heading-epithet::after {\n      content: '」';\n      margin-left: 3px;\n    }\n\n    #st-ext-status-bar .st-ext-icon {\n      display: inline-flex;\n      align-items: center;\n      justify-content: center;\n      width: 26px;\n      height: 26px;\n      border-radius: 999px;\n      border: 1px solid rgba(149, 119, 77, 0.35);\n      background: radial-gradient(circle at 32% 28%, rgba(255, 255, 255, 0.68), rgba(217, 189, 140, 0.18));\n      box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.45);\n      color: #71542f;\n      flex-shrink: 0;\n    }\n\n    #st-ext-status-bar .st-ext-icon svg {\n      width: 74%;\n      height: 74%;\n    }\n\n    #st-ext-status-bar .st-ext-icon-subgroup,\n    #st-ext-status-bar .st-ext-icon-item {\n      width: 22px;\n      height: 22px;\n      border-width: 1px;\n    }\n\n    #st-ext-status-bar .st-ext-status-list {\n      display: grid;\n      grid-template-columns: minmax(110px, 128px) 1fr;\n      gap: 6px 12px;\n      margin: 0;\n    }\n\n    #st-ext-status-bar .st-ext-status-list dt {\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      font-size: 0.82rem;\n      color: rgba(92, 68, 37, 0.9);\n      letter-spacing: 0.04em;\n    }\n\n    #st-ext-status-bar .st-ext-status-list dd {\n      margin: 0;\n      font-size: 0.84rem;\n      color: #3b2916;\n      font-weight: 500;\n      padding: 4px 10px;\n      background: rgba(255, 248, 235, 0.72);\n      border-radius: 9px;\n      border: 1px solid rgba(184, 149, 96, 0.18);\n      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5);\n    }\n\n    #st-ext-status-bar .st-ext-status-placeholder {\n      margin: 0;\n      font-size: 0.82rem;\n      color: rgba(88, 64, 37, 0.75);\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      background: rgba(255, 248, 235, 0.6);\n      border-radius: 9px;\n      border: 1px dashed rgba(184, 149, 96, 0.38);\n      padding: 6px 10px;\n      font-style: italic;\n    }\n\n    #st-ext-status-bar .st-ext-status-subgroup {\n      padding: 8px 0 0;\n      border-top: 1px dashed rgba(140, 107, 66, 0.24);\n      margin-top: 6px;\n    }\n\n    #st-ext-status-bar .st-ext-status-subgroup:first-of-type {\n      border-top: none;\n      padding-top: 0;\n      margin-top: 0;\n    }\n\n    #st-ext-status-bar .st-ext-section-content {\n      display: flex;\n      flex-direction: column;\n      gap: 10px;\n      padding-top: 6px;\n    }\n\n    #st-ext-status-bar .st-ext-collapsible .st-ext-section-content {\n      overflow: hidden;\n    }\n\n    #st-ext-status-bar .st-ext-collapsible-trigger {\n      cursor: pointer;\n      user-select: none;\n      border-radius: 10px;\n      padding: 2px 6px;\n      transition: background ${COLLAPSE_ANIMATION_MS}ms ease, color ${COLLAPSE_ANIMATION_MS}ms ease;\n    }\n\n    #st-ext-status-bar .st-ext-collapsible-trigger:hover {\n      background: rgba(210, 178, 128, 0.18);\n    }\n\n    #st-ext-status-bar .st-ext-collapsible-trigger:focus-visible {\n      outline: none;\n      box-shadow: 0 0 0 2px rgba(199, 155, 48, 0.45);\n    }\n\n    #st-ext-status-bar .st-ext-collapse-indicator {\n      margin-left: 12px;\n      display: inline-flex;\n      width: 18px;\n      height: 18px;\n      align-items: center;\n      justify-content: center;\n      color: rgba(116, 88, 52, 0.88);\n      transition: transform ${COLLAPSE_ANIMATION_MS}ms ease;\n    }\n\n    #st-ext-status-bar .st-ext-collapsible.is-collapsed .st-ext-collapse-indicator {\n      transform: rotate(-90deg);\n    }\n\n    #st-ext-status-bar .st-ext-collapsible.is-collapsed .st-ext-section-content {\n      opacity: 0;\n    }\n\n    #st-ext-status-bar .st-ext-collapsible .st-ext-section-content {\n      opacity: 1;\n      transition: opacity ${COLLAPSE_ANIMATION_MS}ms ease;\n    }\n\n    #st-ext-status-bar .st-ext-status-ode {\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      gap: 12px;\n      padding-top: 20px;\n      margin: 4px 0 0;\n      border-top: 1px dashed rgba(117, 94, 60, 0.35);\n    }\n\n    #st-ext-status-bar .st-ext-status-ode::before {\n      content: \"\";\n      width: 68%;\n      height: 1px;\n      background: linear-gradient(90deg, rgba(199, 155, 48, 0), rgba(199, 155, 48, 0.55), rgba(199, 155, 48, 0));\n    }\n\n    #st-ext-status-bar .st-ext-ode-epithet {\n      font-size: 0.82rem;\n      color: rgba(117, 86, 45, 0.85);\n      letter-spacing: 0.18em;\n      text-shadow: 0 1px 0 rgba(255, 255, 255, 0.45);\n    }\n\n    #st-ext-status-bar .st-ext-status-ode-content {\n      margin: 0;\n      font-size: 0.94rem;\n      color: #cfa63a;\n      font-weight: 700;\n      letter-spacing: 0.12em;\n      white-space: pre-line;\n      padding: 10px 18px;\n      border-radius: 12px;\n      border: 1px solid rgba(199, 155, 48, 0.42);\n      background: rgba(255, 248, 235, 0.66);\n      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5), 0 8px 18px rgba(112, 82, 46, 0.18);\n      text-shadow: 0 1px 4px rgba(98, 68, 24, 0.35);\n    }\n\n    @media (prefers-reduced-motion: reduce) {\n      #st-ext-status-bar {\n        backdrop-filter: none;\n      }\n\n      #st-ext-status-bar .st-ext-collapsible .st-ext-section-content,\n      #st-ext-status-bar .st-ext-collapse-indicator,\n      #st-ext-status-bar .st-ext-collapsible-trigger {\n        transition: none !important;\n      }\n    }\n  `;\n\n  document.head.appendChild(style);\n}\n\nfunction setupStatusBarSkeleton(state) {\n  if (typeof window === 'undefined' || !window.document) {\n    return;\n  }\n\n  const bootstrap = () => {\n    injectStatusBarStyles();\n    renderStatusBar(state);\n  };\n\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', bootstrap, { once: true });\n  } else {\n    bootstrap();\n  }\n}\n\n// ------ 扩展：多角色聊天分割与渲染主函数 ------\nfunction formatAndRenderMultiRoleChat(inputText) {\n  // 分割正则\n  const regex = /\\[([^\\]\\n]+)\\]\\s*([\\s\\S]*?)(?=\\n\\[[^\\]]+\\]|$)/g;\n  let match;\n  while ((match = regex.exec(inputText)) !== null) {\n    const roleName = match[1].trim();\n    const content = match[2].trim();\n    const avatar = avatarMap[roleName] || avatarMap[\"默认\"];\n\n    // 格式化消息 HTML（自定义美化格式）\n    const html = `\n      <div style=\"display:flex;align-items:flex-start;margin-bottom:8px;\">\n        <img src=\"${avatar}\" alt=\"${roleName}\" style=\"width:48px;height:48px;border-radius:50%;margin-right:10px;\">\n        <div>\n          <strong style=\"font-size:1.1em;color:#336;\">${roleName}</strong>\n          <div style=\"white-space:pre-line;margin-top:3px;\">${content}</div>\n        </div>\n      </div>\n    `;\n    \n    // SillyTavern扩展API：插入为新的消息楼层\n    if (window?.TavernHelper?.builtin?.addOneMessage) {\n      window.TavernHelper.builtin.addOneMessage(\n        {\n          name: roleName,\n          role: 'assistant',\n          message: html,\n          data: {}\n        },\n        { type: 'normal', showSwipes: false }\n      );\n    } else {\n      // 非扩展环境调试输出\n      console.log(`[${roleName}]`, content);\n    }\n  }\n}\n\n// 注册按钮到扩展侧栏，实现一键粘贴批量格式化\nfunction setupMultiRoleFormatterButton() {\n  if (window?.TavernHelper?.appendInexistentScriptButtons) {\n    window.TavernHelper.appendInexistentScriptButtons([\n      { name: '批量格式化多角色聊天', visible: true }\n    ]);\n    const eventType = window.getButtonEvent?.('批量格式化多角色聊天');\n    if (eventType) {\n      window.eventOn(eventType, async () => {\n        let txt = prompt(\"粘贴或输入多角色聊天文本:\\n\\n格式：[角色名] 内容...\");\n        if (txt) {\n          formatAndRenderMultiRoleChat(txt);\n        }\n      });\n    }\n  }\n}\n\n// 扩展加载时自动注册按钮\nsetupMultiRoleFormatterButton();\n\n// 支持全局调用\nwindow.multiRoleChatFormatter = formatAndRenderMultiRoleChat;\n\n// 初始化状态栏骨架\nsetupStatusBarSkeleton(initialStatusBarState);\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","window.TavernHelper = window.TavernHelper || {};\n\nimport './index.css';\nimport './extension.js';\n"],"names":["avatarMap","initialStatusBarState","JSON","parse","String","raw","COLLAPSIBLE_SECTIONS","Set","COLLAPSE_ANIMATION_MS","SECTION_EPITHETS","SECTION_ICON_MAP","default","SUBGROUP_ICON_MAP","ITEM_ICON_MAP","COLLAPSE_INDICATOR_SVG","createIconSpan","type","key","map","svg","span","document","createElement","className","setAttribute","innerHTML","createSectionShell","title","options","section","header","headerIcon","appendChild","headerText","textContent","headerEpithet","createSectionEpithet","content","append","collapseControls","collapsible","classList","add","collapsed","duration","tabIndex","style","transition","indicator","setCollapsed","state","requestAnimationFrame","maxHeight","opacity","remove","scrollHeight","toggle","isCollapsed","contains","addEventListener","event","preventDefault","refresh","ResizeObserver","observe","setupCollapsible","appendIconAndText","target","icon","text","tagName","element","extractEntryValue","entry","Array","isArray","value","$meta","renderPrimitiveSection","entries","has","currentList","flushList","children","length","Object","forEach","subDetails","subHeader","label","subList","subKey","subValue","dt","dtIcon","dtLabel","dd","renderStatusBar","window","root","querySelector","container","id","createStatusBarContainer","body","odeValue","sectionTitle","sectionValue","info","odeEpithet","formatAndRenderMultiRoleChat","inputText","regex","match","exec","roleName","trim","html","TavernHelper","builtin","addOneMessage","name","role","message","data","showSwipes","console","log","appendInexistentScriptButtons","visible","eventType","getButtonEvent","eventOn","async","txt","prompt","setupMultiRoleFormatterButton","multiRoleChatFormatter","bootstrap","getElementById","head","injectStatusBarStyles","readyState","once","setupStatusBarSkeleton","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","exports","module","__webpack_modules__","n","getter","__esModule","d","a","definition","o","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call"],"sourceRoot":""}